{
	"cvss": {
		"score": 9.1,
		"vector_string": "CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:C/C:H/I:H/A:H"
	},
	"cwes": [
		{
			"cwe_id": "CWE-285",
			"name": "Improper Authorization"
		}
	],
	"ghsa_id": "GHSA-6x34-89p7-95wg",
	"summary": "Downstream cluster privilege escalation through cluster and project role template binding (CRTB/PRTB)",
	"description": "### Impact\r\n\r\nAn issue was discovered in Rancher versions up to and including 2.5.15 and 2.6.6 where a flaw with authorization logic allows privilege escalation through cluster role template binding (CRTB) and project role template binding (PRTB). This issue does not affect the local cluster, it affects only downstream clusters.\r\n\r\nThe vulnerability can be exploited by any user who has permissions to create/edit cluster role template bindings or project role template bindings (such as `cluster-owner`, `manage cluster members`, `project-owner` and `manage project members`) to gain `owner` permission in another project in the same cluster or in another project on a different downstream cluster.\r\n\r\n   - The user must have `kubectl` access in the local cluster to exploit this scenario.\r\n\r\n   - This can only be abused to gain `cluster-owner` permission on a different downstream cluster if the user is already `cluster-owner` on at least one downstream cluster.\r\n\r\n   - Example of a modified CRTB (note: the `clusterName` points to the cluster ID of the cluster that the privileges will be escalated and `namespace` points to the current cluster ID that the user has permissions):\r\n```\r\nkubectl edit clusterroletemplatebindings crtb-\u003ccrtb-ID\u003e -n c-\u003ccluster-ID\u003e\r\n---\r\napiVersion: management.cattle.io/v3\r\nclusterName: \u003cID-of-the-cluster-to-escalate\u003e\r\nkind: ClusterRoleTemplateBinding\r\nmetadata:\r\n  annotations:\r\n    \u003comitted\u003e \r\n  finalizers:\r\n  - \u003comitted\u003e \r\n  generateName: crtb-\r\n  labels:\r\n    \u003comitted\u003e \r\n    cattle.io/creator: norman\r\n  name: crtb-\u003ccrtb-ID\u003e\r\n  namespace: c-\u003ccurrent-cluster-ID\u003e\r\nroleTemplateName: cluster-owner\r\nuserName: u-\u003cuser-ID\u003e\r\nuserPrincipalName: local://u-\u003cuser-ID\u003e\r\n```\r\n\r\nAn artifact to flag the exploitation of this issue is that the `namespace` of the CRTB/PRTB will not match the cluster name (`clusterName`) of the CRTB/PRTB. For example, every CRTB in the `c-123xyz` namespace should have a cluster name of `c-123xyz`. If instead, the cluster name is `c-abc567`, for example, this is likely a result of a user exploiting this flaw.\r\n\r\nFor more information about cluster and project roles, please consult Rancher's [documentation](https://rancher.com/docs/rancher/v2.6/en/admin-settings/rbac/cluster-project-roles/).\r\n\r\n### Patches\r\n\r\nPatched versions include releases 2.5.16, 2.6.7 and later versions.\r\n\r\n### Workarounds\r\n\r\nLimit access in Rancher to trusted users. There is not a direct mitigation besides upgrading to the patched Rancher versions.\r\n\r\n**Important:**\r\n- It is highly advised to check the local and downstream clusters for potential unrecognized CRTBs (`kubectl get clusterroletemplatebindings -A`) and PRTBs (`kubectl get projectroletemplatebindings -A`) assignments.\r\n- The ability to add other users to projects and clusters is a highly-privileged permission which may result in users being able to operate beyond their explicitly specified RBAC. It is recommended that this permission be granted selectively.\r\n\r\nThe following script can be used as a helper to detect possible deviations of CRTBs and PRTBs that do not match the expected value. Further investigation is required to determine if the flagged objects were maliciously modified or not. The script requires `kubectl` access to the `local` cluster and the `jq` command.\r\n\r\n```shell\r\n#!/usr/bin/env bash\r\n\r\necho \"CRTBs that don't match cluster:\"\r\nkubectl get clusterroletemplatebindings -A -o=jsonpath=\"{range .items[?(@.clusterName!=@.metadata.namespace)]}{.metadata.name}{'\\n'}{end}\"\r\n\r\necho \"PRTBs that don't match project:\"\r\nkubectl get projectroletemplatebindings -A -ojson | jq -r '.items[]|.metadata as $m|select(.projectName|endswith($m.namespace)|not)|.metadata.name'\r\n```\r\n\r\n### For more information\r\n\r\nIf you have any questions or comments about this advisory:\r\n\r\n* Reach out to [SUSE Rancher Security team](https://github.com/rancher/rancher/security/policy) for security related inquiries.\r\n* Open an issue in [Rancher](https://github.com/rancher/rancher/issues/new/choose) repository.\r\n* Verify our [support matrix](https://www.suse.com/suse-rancher/support-matrix/all-supported-versions/) and [product support lifecycle](https://www.suse.com/lifecycle/).",
	"severity": "critical",
	"identifiers": [
		{
			"value": "GHSA-6x34-89p7-95wg",
			"type": "GHSA"
		},
		{
			"value": "CVE-2022-31247",
			"type": "CVE"
		}
	],
	"published_at": "2022-08-19T03:51:04Z",
	"updated_at": "2022-08-19T03:51:04Z",
	"vulnerabilities": [
		{
			"package": {
				"ecosystem": "go",
				"name": "rancher/rancher"
			},
			"vulnerable_version_range": "From 2.5.0 and 2.6.0 up to and including 2.5.15 and 2.6.6",
			"patched_versions": "2.5.16, 2.6.7 and later releases"
		}
	],
	"cve_id": "CVE-2022-31247",
	"url": "https://api.github.com/repos/rancher/rancher/security-advisories/GHSA-6x34-89p7-95wg",
	"html_url": "https://github.com/rancher/rancher/security/advisories/GHSA-6x34-89p7-95wg",
	"publisher": {
		"login": "rmweir",
		"id": 19376037,
		"node_id": "MDQ6VXNlcjE5Mzc2MDM3",
		"avatar_url": "https://avatars.githubusercontent.com/u/19376037?v=4",
		"html_url": "https://github.com/rmweir",
		"gravatar_id": "",
		"type": "User",
		"site_admin": false,
		"url": "https://api.github.com/users/rmweir",
		"events_url": "https://api.github.com/users/rmweir/events{/privacy}",
		"following_url": "https://api.github.com/users/rmweir/following{/other_user}",
		"followers_url": "https://api.github.com/users/rmweir/followers",
		"gists_url": "https://api.github.com/users/rmweir/gists{/gist_id}",
		"organizations_url": "https://api.github.com/users/rmweir/orgs",
		"received_events_url": "https://api.github.com/users/rmweir/received_events",
		"repos_url": "https://api.github.com/users/rmweir/repos",
		"starred_url": "https://api.github.com/users/rmweir/starred{/owner}{/repo}",
		"subscriptions_url": "https://api.github.com/users/rmweir/subscriptions"
	},
	"state": "published",
	"cwe_ids": [
		"CWE-285"
	]
}